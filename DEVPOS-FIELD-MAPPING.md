# DevPos to QuickBooks Field Mapping Reference

## Date Fields Currently Checked (In Order of Priority)

### For Sales Invoices & Cash Sales
The system checks these fields in order and uses the first one found:

1. `issueDate` - Primary field for invoice issue date
2. `dateCreated` - Alternative creation date field
3. `created_at` - Alternative timestamp field
4. `dateIssued` - Alternative issue date field
5. `date` - Generic date field
6. `invoiceDate` - Invoice-specific date field
7. `documentDate` - Document date field
8. **FALLBACK**: If none found, uses `date('Y-m-d')` (today's date) ⚠️

### For Purchase Bills
Same date fields as above, checked in the same order.

---

## Known DevPos API Response Fields

### Sales E-Invoice Response (from `EInvoice/GetSalesInvoice`)
Based on **official API documentation section 5.3**:

#### Document Identification
- `invoiceNumber` - Invoice number
- `invoiceOrderNumber` - Order number
- `iic` - NSLF number generated by devPOS
- `EIC` - Electronic invoice number (for e-invoices)
- `fiscNumber` - Fiscalization number from tax system

#### Date Fields ✅ CONFIRMED
- **`dateTimeCreated`** - Invoice creation date (THIS IS THE PRIMARY DATE FIELD)
- `dueDate` - Payment deadline (if specified)
- `supplyDateOrPeriodStart` - Supply start date (optional)
- `supplyDateOrPeriodEnd` - Supply end date (optional)

#### Financial Data
- `totalAmount` - Total invoice amount
- `total` - Alternative total field
- `amount` - Alternative amount field

#### Buyer Information
- `buyerName` - Customer name
- `buyer_name` - Alternative buyer name
- `customerName` - Alternative customer name
- `buyerNuis` - Buyer tax ID (NUIS)

#### Invoice Classification
- `isSimplifiedInvoice` or `SimplifiedInvoice` - Boolean flag for cash sales
- `invoicePayments` - Array of payment methods
  - `paymentMethodType` - 0 = Cash, 1 = Card

#### PDF Attachment
- `pdf` - Base64 encoded PDF (may need separate call to `getEInvoiceByEIC`)

---

### Purchase E-Invoice Response (from `EInvoice/GetPurchaseInvoice`)
Similar structure to sales invoices:

#### Vendor Information
- `sellerName` or `seller_name` - Vendor name
- `sellerNuis` or `seller_nuis` - Vendor tax ID (NUIS)
- `vendorName` - Alternative vendor name field

#### Same Fields as Sales Invoices
- Document numbers, dates, amounts, EIC, PDF

---

## Current Sync Behavior

### What Gets Logged (After Latest Update)
When a sync runs, the system now logs:

1. **First document of each type** - Full JSON structure
2. **Available field names** - List of all fields present
3. **Date field used** - Which field was actually used for the date
4. **Warnings** - If no date field found

### How to Check Logs
```bash
# On production server
ssh root@78.46.201.151
tail -200 /var/log/apache2/error.log | grep "DEBUG:\|INFO:\|WARNING:"
```

Look for:
- `=== DEBUG: DevPos Invoice Structure ===`
- `=== DEBUG: DevPos Cash Sale Structure ===`
- `=== DEBUG: DevPos Purchase Bill Structure ===`
- `INFO: Using date field with value: YYYY-MM-DD`
- `WARNING: No date found in DevPos invoice`

---

## Attachment Handling

### PDF Attachments from DevPos
The sync attempts to attach PDFs in this order:

1. Check if `pdf` field exists in document (Base64 encoded)
2. If not found, make separate API call: `getEInvoiceByEIC(eic)`
3. Check `pdf` field in detailed response
4. If found, decode Base64 and upload to QuickBooks

### QuickBooks Upload
```php
$this->qbo->uploadAttachment($entityType, $qboId, $filename, $binary, $replace);
```

**Parameters:**
- `$entityType` - 'Invoice', 'Bill', or 'SalesReceipt'
- `$qboId` - QuickBooks entity ID
- `$filename` - `{documentNumber}.pdf`
- `$binary` - Decoded PDF binary data
- `$replace` - Boolean (currently `false`)

---

## Field Mapping to QuickBooks

### Invoice Mapping (Sales)
| DevPos Field | QuickBooks Field | Notes |
|-------------|------------------|-------|
| `issueDate` (or alternatives) | `TxnDate` | Invoice date |
| `documentNumber` | `DocNumber` | Invoice number |
| `totalAmount` | `Line[0].Amount` | Total amount |
| `buyerName` | `CustomerRef` | Maps to QBO customer |
| `eic` | `CustomField` | If `QBO_CF_EIC_DEF_ID` set |

### Bill Mapping (Purchases)
| DevPos Field | QuickBooks Field | Notes |
|-------------|------------------|-------|
| `issueDate` (or alternatives) | `TxnDate` & `DueDate` | Bill date |
| `documentNumber` | `DocNumber` | Bill number |
| `totalAmount` | `Line[0].Amount` | Total amount |
| `sellerNuis` | `VendorRef` | Auto-create vendor |
| `eic` | `PrivateNote` | With NUIS |

### Cash Sale Mapping (Sales Receipts)
| DevPos Field | QuickBooks Field | Notes |
|-------------|------------------|-------|
| `issueDate` (or alternatives) | `TxnDate` | Transaction date |
| `documentNumber` | `DocNumber` | Receipt number |
| `totalAmount` | `Line[0].Amount` | Total amount |
| `invoicePayments[0].paymentMethodType` | `PaymentMethodRef` | 0=Cash, 1=Card |

---

## Known Issues

### ⚠️ Date Issue
**Problem:** Transactions sometimes created with today's date instead of actual invoice date

**Possible Causes:**
1. DevPos API doesn't return any of the checked date fields
2. Date field exists but has `null` or empty value
3. Date field uses different name not in our list

**Solution:** 
- Enhanced logging deployed (October 27, 2025)
- Run sync and check logs to identify actual field name
- Update transformers with correct field name

### ⚠️ Attachment Issue  
**Problem:** Attachments not showing in QuickBooks

**Possible Causes:**
1. `pdf` field not included in list response
2. Second API call to `getEInvoiceByEIC()` failing silently
3. PDF data corrupted during Base64 decode
4. QuickBooks API upload failing silently

**Current Error Handling:**
```php
try {
    $this->qbo->uploadAttachment(...);
} catch (\Throwable $e) {
    // Silently ignored - no error logged!
}
```

**Recommendation:** Add error logging to catch failures

---

## Next Steps to Debug

1. **Run a sync job** on production
2. **Check logs** for the DEBUG output showing actual DevPos structure
3. **Identify the correct date field name** from the logs
4. **Update transformers** with the correct field name
5. **Add error logging** for attachment upload failures
6. **Re-test** with another sync

---

## Useful Commands

```bash
# Check recent sync logs
ssh root@78.46.201.151 "tail -200 /var/log/apache2/error.log"

# Search for specific patterns
ssh root@78.46.201.151 "grep -i 'DEBUG:\|date\|attachment' /var/log/apache2/error.log | tail -100"

# Check PHP error log
ssh root@78.46.201.151 "tail -100 /home/converter/web/devsync.konsulence.al/public_html/storage/logs/error.log"

# Run manual sync via API
curl -X POST https://devsync.konsulence.al/api/sync/sales \
  -H "X-API-Key: YOUR_KEY" \
  -H "Content-Type: application/json" \
  -d '{"company_id": 1, "from": "2025-10-01", "to": "2025-10-27"}'
```

---

**Last Updated:** October 27, 2025
**Status:** Date debugging deployed, awaiting log analysis
